<!DOCTYPE html>
<html>
<head>
    <title>BacklogGroomer</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){Ext.define("ChildUserStoriesPopover",{alias:"childuserstoriespopover",extend:"Rally.ui.popover.Popover",requires:["Rally.ui.popover.ChildItemsListView"],clientMetrics:[{event:"show",description:"popover opened"}],mixins:{clientMetrics:"Rally.clientmetrics.ClientMetricsRecordable"},id:"grid-popover",cls:"grid-popover",title:"Child User Stories",titleIconCls:"icon-story",width:750,maxHeight:600,layout:"fit",constructor:function(config,record){var items=[Ext.merge({xtype:"rallygrid",itemId:"listview",enableBulkEdit:!0,record:config.record,storeConfig:{listeners:{load:{fn:this._onStoreLoad,scope:this,options:{single:!0}}},filters:[{property:"Parent.ObjectID",operator:"=",value:record.get("ObjectID")}]},columnCfgs:[{dataIndex:"FormattedID",width:90},{dataIndex:"Name",flex:1},{dataIndex:"Parent",width:180}]},{model:Ext.identityFn("HierarchicalRequirement"),parentProperty:"Parent",childField:"Children",addNewConfig:null,gridConfig:{storeConfig:{context:config.context,model:record,listeners:{load:this._onStoreLoad,scope:this}}}},config.listViewConfig),{xtype:"rallybutton",text:"Click me",handler:function(){Ext.Msg.alert("Button","You clicked me")}}];config.items=Ext.merge(items,config.items),this.record=config.record,this.callParent(arguments)},initComponent:function(){this.recordLoadBegin({description:"listview popover created",startTime:(new Date).getTime()}),this.callParent(arguments)},getGrid:function(){return this.down("#listview").getGrid()},_onStoreLoad:function(){Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this),this.recordLoadEnd({stopTime:(new Date).getTime()})}})})();
                Ext.define("TreesWithCardsItem",{extend:"Rally.ui.tree.TreeItem",xtype:"treeswithcardsitem",listeners:{}}),Ext.define("TreesWithCards",{extend:"Rally.ui.tree.Tree",getTreeItemConfigForRecordFn:function(){return function(){}},makeTreeItemDraggable:function(treeItem){var tree=this;if(treeItem.getCanDrag()){var me=this,dragSource=Ext.create("Ext.dd.DragSource",treeItem.getEl(),{treeItem:treeItem,getDragData:function(){var ret={card:Ext.create("Rally.ui.cardboard.Card",{record:treeItem.getRecord()}),column:{findCardInfo:function(){return{index:-1}}}};return ret},ddGroup:"cardboard",isTarget:!1,proxy:Ext.create("Ext.dd.StatusProxy",{animRepair:!0,shadow:!1,dropNotAllowed:"rallytree-proxy"}),beforeDragDrop:function(){return me.fireEvent("drag",treeItem),!0},afterDragDrop:function(){me.fireEvent("drop",treeItem)}});dragSource.setHandleElId(treeItem.getEl().down(".drag").id)}if(treeItem.getCanDropOnMe()){var dropTarget=Ext.create("Rally.ui.tree.TreeItemDropTarget",treeItem.down("#treeItemContent").getEl(),{tree:tree,treeItem:treeItem});treeItem.dropTarget&&treeItem.dropTarget.unreg(),treeItem.dropTarget=dropTarget;var dropTargetGroups=this.getDragThisGroupOnMeFn().call(this.getScope(),treeItem.getRecord());Ext.isArray(dropTargetGroups)||(dropTargetGroups=[dropTargetGroups]),Ext.each(dropTargetGroups,function(dropTargetGroup){dropTarget.addToGroup(dropTargetGroup)})}},treeItemConfigForRecordFn:function(record){var card=Ext.create("Rally.ui.cardboard.Card",{record:record});return{xtype:"treeswithcardsitem",canDrag:!0,expanded:!0,record:record,card:card}}}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:{type:"hbox",align:"stretch"},launch:function(){this.leftContainer=Ext.create("Ext.Container",{flex:1,align:"stretch"}),this.rightContainer=Ext.create("Ext.Container",{id:"rightcontainer",flex:2,align:"stretch"}),this.add([this.leftContainer,this.rightContainer]),this.buildOrphanedStoryTree(),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:["userstory"],autoLoad:!0,enableHierarchy:!0}).then({success:this._onStoreBuilt,scope:this})},buildOrphanedStoryTree:function(){var parentFilter=Ext.create("Rally.data.QueryFilter",{property:"Parent",value:"null",operator:"="}),childrenFilter=Ext.create("Rally.data.QueryFilter",{property:"DirectChildrenCount",value:"0",operator:"="}),filter=parentFilter.and(childrenFilter),orphanStoryTree=Ext.create("TreesWithCards",{enableDragAndDrop:!0,dragDropGroupFn:function(record){return"cardboard"},dragThisGroupOnMeFn:function(record){return"cardboard"},topLevelStoreConfig:{model:"User Story",fetch:["FormattedID","Name","ObjectID","DirectChildrenCount"],filters:filter,canDrag:!0,sorters:[{property:"Rank",direction:"asc"}],listeners:{load:function(store,records,successful,options){store.totalCount>200&&Rally.ui.notify.Notifier.showError({message:"There are more than 200 orphaned stories."})}}}});this.leftContainer.add(orphanStoryTree)},_onStoreBuilt:function(store){this.rightContainer.add({xtype:"rallytreegrid",store:store,context:this.getContext(),columnCfgs:["Name","ScheduleState","Owner"],rowActionColumnConfig:{xtype:"rallyrowactioncolumn",rowActionsFn:function(record){return[{text:"Split Child Stories...",record:record,handler:function(){Ext.create("childuserstoriespopover",{field:"UserStory",record:record,target:"rightcontainer"},record)}}]}},padding:"5"})},_onUnparentedDataLoaded:function(store,data){this.leftContainer.add({xtype:"rallygrid",showPagingToolbar:!1,showRowActionsColumn:!1,enableRanking:!0,editable:!1,store:store,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",width:100,tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:1}],padding:"5"})}});

            Rally.launchApp('CustomApp', {
                name:"BacklogGroomer",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
